{% extends "transcription/base.html" %}
{% load static %}
{% block title %}Processing Audio{% endblock %}

{% block content %}
<div class="sticky top-4 z-10 bg-slate-50/90 backdrop-blur rounded-lg p-4 border shadow-sm mb-4">
    <h2 class="text-2xl font-semibold mb-2">Processing Interviews</h2>
    <p class="text-sm text-gray-600 mb-3">
        {{ stats.active }} active • {{ stats.done }} done • {{ stats.error }} error • {{ stats.cancelled }} cancelled
    </p>
    <div class="flex flex-wrap gap-2">
        <button
            id="retryAllBtn"
            type="button"
            class="text-sm font-semibold px-3 py-1.5 rounded bg-blue-100 text-blue-700 hover:bg-blue-200"
        >
            Retry All Failed
        </button>
        <button
            id="cancelAllBtn"
            type="button"
            class="text-sm font-semibold px-3 py-1.5 rounded bg-red-100 text-red-700 hover:bg-red-200"
        >
            Cancel All
        </button>
        <button
            id="toggleFinishedBtn"
            type="button"
            class="text-sm font-semibold px-3 py-1.5 rounded bg-gray-100 text-gray-700 hover:bg-gray-200"
        >
            Hide Finished
        </button>
    </div>
</div>

<div class="space-y-4">
    {% if processing_list %}
    {% for t in processing_list %}
    <div class="bg-white rounded-lg shadow p-6" data-transcription-id="{{ t.id }}">
        <div class="flex items-center justify-between gap-4">
            <div>
                <p class="text-sm text-gray-500">File</p>
                <p class="font-semibold text-gray-800 break-all">{{ t.audio_file.name|default:"transcript" }}</p>
            </div>
            <div class="flex items-center gap-2">
                <span class="status-badge text-xs font-semibold px-2 py-1 rounded bg-blue-100 text-blue-700">
                    Processing
                </span>
                <button
                    type="button"
                    class="cancel-btn text-xs font-semibold px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200"
                    data-cancel-id="{{ t.id }}"
                >
                    Cancel
                </button>
            </div>
        </div>

        <p class="status-text mt-3 mb-1 text-gray-700">Processing your audio...</p>
        <p class="stage-text text-xs text-gray-500 hidden"></p>

        <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
            <div class="progress-bar bg-blue-600 h-4 rounded-full w-0 transition-all"></div>
        </div>
        <div class="flex items-center justify-between">
            <p class="progress-text text-sm text-gray-600">0%</p>
            <div class="flex items-center gap-3">
                <a class="view-link hidden text-sm text-blue-600 hover:underline" href="{% url 'transcription:transcription_detail' t.id %}">
                    View Transcript
                </a>
                <button
                    type="button"
                    class="retry-btn hidden text-sm text-blue-600 hover:underline"
                    data-retry-id="{{ t.id }}"
                >
                    Retry
                </button>
            </div>
        </div>
        <p class="eta-text mt-2 text-xs text-gray-500 hidden"></p>
        <p class="elapsed-text mt-1 text-xs text-gray-500 hidden"></p>
        <p class="error-text hidden mt-2 text-sm text-red-600"></p>
    </div>
    {% endfor %}
    {% else %}
    <div class="bg-white rounded-lg shadow p-6">
        <p class="text-gray-700">No transcriptions are currently processing.</p>
        <a class="text-blue-600 hover:underline text-sm" href="{% url 'transcription:upload_audio' %}">
            Upload a new audio file
        </a>
    </div>
    {% endif %}
</div>

<!-- Confirmation Modal -->
<div id="confirmOverlay" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6">
        <h3 id="confirmTitle" class="text-lg font-semibold text-gray-800 mb-2">Confirm</h3>
        <p id="confirmMessage" class="text-sm text-gray-600 mb-4">Are you sure?</p>
        <div class="flex justify-end gap-2">
            <button id="confirmCancel" type="button" class="px-4 py-2 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">
                No
            </button>
            <button id="confirmOk" type="button" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                Yes
            </button>
        </div>
    </div>
</div>

<script id="isMulti" type="application/json">{{ is_multi|yesno:"true,false" }}</script>
<script src="{% static 'transcription/processing.js' %}"></script>
{% endblock %}
