{% extends "transcription/base.html" %}
{% load custom_filters %}
{% block title %}Review Interview{% endblock %}

{% block content %}
<h2 class="text-2xl font-semibold mb-1">Interview Review</h2>
<p class="text-sm text-gray-600 mb-6">
    File: <span class="font-medium text-gray-800">{{ transcription.audio_file.name|basename|default:"(no file)" }}</span>
</p>

<div class="grid gap-6 lg:grid-cols-[360px_1fr]">
    <div class="space-y-4 lg:sticky lg:top-6 lg:self-start">

<!-- Audio Player -->
{% if audio_exists %}
<div class="bg-white rounded-lg shadow p-4">
    <audio id="audioPlayer" controls class="w-full" src="{% url 'transcription:transcription_audio' transcription.id %}"></audio>
</div>
{% else %}
<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg p-4">
    <p class="mb-2">Audio file not found. It may have been deleted from the server.</p>
    <a href="{% url 'transcription:upload_audio' %}"
       class="inline-flex items-center rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700 text-sm font-semibold">
        Re-upload Audio
    </a>
</div>
{% endif %}

<!-- ACTION BAR -->
<div id="actionBar" class="bg-white p-4 flex flex-wrap items-center gap-4 border border-gray-100 rounded-lg shadow-sm">
    <!-- Export Dropdown -->
    <div class="relative inline-block text-left">
        <button id="exportBtn" class="inline-flex justify-center gap-x-1.5 rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-blue-600 hover:bg-gray-200">
            Export
            <svg viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 -mr-1 text-gray-500">
                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z" clip-rule="evenodd"/>
            </svg>
        </button>

        <!-- Export menu -->
        <div id="exportMenu" class="hidden absolute mt-2 w-48 rounded-md bg-white shadow-lg border border-gray-200 py-2 z-50">
            <!-- Options: format, timestamps, speakers -->
            <div class="px-4 py-2">
                <label class="block text-gray-700 text-sm mb-1">Format:</label>
                <select id="exportFormat" class="w-full border rounded px-2 py-1">
                    <option value="txt">TXT</option>
                    <option value="pdf">PDF</option>
                    <option value="docx">DOCX</option>
                    <option value="srt">SRT</option>
                </select>
            </div>
            <div class="px-4 py-2 flex items-center gap-2">
                <input type="checkbox" id="exportTimestamps" />
                <label for="exportTimestamps" class="text-gray-700 text-sm">Include Timestamps</label>
            </div>
            <div class="px-4 py-2 flex items-center gap-2">
                <input type="checkbox" id="exportSpeakers" />
                <label for="exportSpeakers" class="text-gray-700 text-sm">Include Speakers</label>
            </div>
            <div class="px-4 py-2">
                <button id="exportConfirmBtn" class="w-full bg-blue-600 text-white py-1 rounded hover:bg-blue-700 text-sm font-semibold">
                    Download
                </button>
            </div>
        </div>
    </div>

    <!-- Save Corrections Button -->
    <button type="submit" form="transcriptForm" class="bg-emerald-600 text-white px-6 py-2 rounded hover:bg-emerald-700">
        Save Corrections
    </button>

    <!-- Translate to Standard English Button -->
    <button id="translateBtn" type="button" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
        Translate to Standard English
    </button>
    <span id="translateStatus" class="text-sm text-gray-600"></span>
    <span id="saveStatus" class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600"></span>

    <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-2 text-sm text-gray-600 relative group">
            <input id="loopToggle" type="checkbox">
            Loop Segment
            <span class="absolute -top-11 left-1/2 hidden w-max -translate-x-1/2 rounded bg-slate-800 px-2 py-1 text-xs text-white shadow-sm group-hover:block transition-opacity duration-150 opacity-0 group-hover:opacity-100">
                Repeat the active segment in a loop
                <span class="absolute left-1/2 top-full -translate-x-1/2 border-x-8 border-t-8 border-x-transparent border-t-slate-800"></span>
            </span>
        </label>
        <button id="jumpPrev" type="button" class="text-sm text-blue-600 hover:underline relative group">
            Prev Match
            <span class="absolute -top-11 left-1/2 hidden w-max -translate-x-1/2 rounded bg-slate-800 px-2 py-1 text-xs text-white shadow-sm group-hover:block transition-opacity duration-150 opacity-0 group-hover:opacity-100">
                Jump to previous search match
                <span class="absolute left-1/2 top-full -translate-x-1/2 border-x-8 border-t-8 border-x-transparent border-t-slate-800"></span>
            </span>
        </button>
        <button id="jumpNext" type="button" class="text-sm text-blue-600 hover:underline relative group">
            Next Match
            <span class="absolute -top-11 left-1/2 hidden w-max -translate-x-1/2 rounded bg-slate-800 px-2 py-1 text-xs text-white shadow-sm group-hover:block transition-opacity duration-150 opacity-0 group-hover:opacity-100">
                Jump to next search match
                <span class="absolute left-1/2 top-full -translate-x-1/2 border-x-8 border-t-8 border-x-transparent border-t-slate-800"></span>
            </span>
        </button>
    </div>

    <div class="flex items-center gap-3 text-sm text-gray-600">
        <label class="flex items-center gap-2">
            <input id="toggleOriginal" type="checkbox" checked>
            Original
        </label>
        <label class="flex items-center gap-2">
            <input id="toggleEnglish" type="checkbox" checked>
            Standard English
        </label>
    </div>
</div>

<!-- FILTER BAR (below action bar) -->
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex flex-wrap gap-4 items-center">
    <!-- Text Search -->
    <input
        id="searchInput"
        type="text"
        placeholder="Search transcriptâ€¦"
        class="border rounded px-3 py-2 w-64"
    >

    <!-- Type Filter: Question/Answer -->
    <select id="typeFilter" class="border rounded px-3 py-2">
        <option value="all">All</option>
        <option value="Question">Questions</option>
        <option value="Answer">Answers</option>
    </select>

    <!-- Speaker Filter -->
    <select id="speakerFilter" class="border rounded px-3 py-2">
        <option value="all">All speakers</option>
        {% for seg in transcription.structured_segments %}
            <option value="{{ seg.speaker }}">{{ seg.speaker }}</option>
        {% endfor %}
    </select>
</div>

<!-- Transcript Table -->
    </div>

    <div>
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-gray-800">Segments</h3>
            <span class="text-sm text-gray-500">{{ transcription.structured_segments|length }} total</span>
        </div>
<!-- Transcript Cards -->
<form method="post" id="transcriptForm" class="mt-0">
{% csrf_token %}
<div id="transcriptBody" class="space-y-4">
    {% for seg in transcription.structured_segments %}
    <div
        class="segment-row bg-white rounded-lg border border-gray-100 p-4 pl-6 transition hover:shadow-md relative"
        data-index="{{ forloop.counter0 }}"
        data-start="{{ seg.start }}"
        data-end="{{ seg.end }}"
        data-type="{{ seg.type }}"
        data-speaker="{{ seg.speaker }}"
        data-text="{{ seg.original|lower }} {{ seg.english|lower }}"
    >
        <div class="absolute left-0 top-0 h-full w-1 bg-blue-200 rounded-l-lg"></div>
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-2">
                <span class="px-2 py-1 rounded-full text-xs font-semibold {{ seg.speaker_color|default:'bg-gray-200 text-gray-800' }}">
                    {{ seg.speaker }}
                </span>
                <button
                    type="button"
                    class="text-xs text-blue-600 hover:underline rename-speaker"
                    data-speaker="{{ seg.speaker }}"
                >
                    Rename
                </button>
                {% if seg.type == 'Question' %}
                    <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">Question</span>
                {% else %}
                    <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Answer</span>
                {% endif %}
            </div>
            <button type="button" class="timestamp-chip text-xs text-gray-600 font-mono" data-seconds="{{ seg.start }}">
                00:00
            </button>
        </div>

        <div class="mt-3 grid gap-3 md:grid-cols-2">
            <div class="col-original">
                <label class="block text-[11px] uppercase tracking-wide text-gray-500 mb-1">Original (Kolokwa)</label>
                <textarea
                    rows="3"
                    class="w-full rounded-md border border-gray-200 bg-[linear-gradient(to_bottom,transparent_24px,#f3f4f6_25px)] bg-[length:100%_25px] p-3 text-sm text-gray-800 shadow-sm focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition auto-save"
                    data-field="original"
                >{{ seg.original }}</textarea>
            </div>
            <div class="col-english">
                <label class="block text-[11px] uppercase tracking-wide text-gray-500 mb-1">Standard English</label>
                <textarea
                    rows="3"
                    class="w-full rounded-md border border-gray-200 bg-[linear-gradient(to_bottom,transparent_24px,#f3f4f6_25px)] bg-[length:100%_25px] p-3 text-sm text-gray-800 shadow-sm focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition auto-save"
                    data-field="english"
                >{{ seg.english }}</textarea>
            </div>
        </div>
    </div>
    {% if not forloop.last %}
    <div class="h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent"></div>
    {% endif %}
    {% endfor %}
</div>
</form>
    </div>
</div>

<script>
// ======================
// Global References
// ======================
const audio = document.getElementById("audioPlayer");
const body = document.getElementById("transcriptBody");
const searchInput = document.getElementById("searchInput");
const typeFilter = document.getElementById("typeFilter");
const speakerFilter = document.getElementById("speakerFilter");
const exportBtn = document.getElementById('exportBtn');
const exportMenu = document.getElementById('exportMenu');
const exportConfirmBtn = document.getElementById('exportConfirmBtn');
const translateBtn = document.getElementById("translateBtn");
const translateStatus = document.getElementById("translateStatus");
const saveStatus = document.getElementById("saveStatus");
const toggleOriginal = document.getElementById("toggleOriginal");
const toggleEnglish = document.getElementById("toggleEnglish");
const loopToggle = document.getElementById("loopToggle");
const jumpPrev = document.getElementById("jumpPrev");
const jumpNext = document.getElementById("jumpNext");

// Scroll-to-top button
const scrollToTopBtn = document.createElement("button");
scrollToTopBtn.id = "scrollToTopBtn";
scrollToTopBtn.type = "button";
scrollToTopBtn.textContent = "To top";
scrollToTopBtn.className =
    "fixed bottom-6 right-6 z-50 hidden rounded-full bg-blue-600 px-4 py-2 text-white shadow-lg hover:bg-blue-700";
document.body.appendChild(scrollToTopBtn);

scrollToTopBtn.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
});

window.addEventListener("scroll", () => {
    scrollToTopBtn.classList.toggle("hidden", window.scrollY < 300);
});

// ======================
// Format seconds to HH:MM:SS
// ======================
function formatTime(sec) {
    sec = Math.floor(sec);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return (h ? String(h).padStart(2, "0") + ":" : "") +
           String(m).padStart(2, "0") + ":" +
           String(s).padStart(2, "0");
}

// Fill timestamp chips
document.querySelectorAll(".timestamp-chip").forEach(t => {
    t.textContent = formatTime(t.dataset.seconds);
});

// ======================
// Segment Click Handling: jump to audio time
// ======================
body.addEventListener("click", e => {
    if (e.target.closest("textarea, input, select, a")) {
        return;
    }
    const isTimestamp = e.target.closest(".timestamp-chip");
    if (e.target.closest("button") && !isTimestamp) {
        return;
    }
    const row = e.target.closest(".segment-row");
    if (!row) return;

    const seconds = row.dataset.start;
    if (!seconds) return;

    const target = Math.min(parseFloat(seconds), audio.duration || Infinity);
    const rowStart = parseFloat(row.dataset.start || row.dataset.seconds || "0");
    const rowEnd = parseFloat(row.dataset.end || rowStart);

    const isWithinRow = audio.currentTime >= rowStart && audio.currentTime <= rowEnd;

    if (isWithinRow) {
        if (!audio.paused) {
            audio.pause();
        } else {
            audio.play();
        }
        return;
    }

    audio.currentTime = target;
    audio.play();
});

// (Highlighting handled in optimized playback section below)

// ======================
// Export Dropdown Handling
// ======================
exportBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    exportMenu.classList.toggle('hidden');
});

document.addEventListener('click', (e) => {
    if (!exportBtn.contains(e.target) && !exportMenu.contains(e.target)) {
        exportMenu.classList.add('hidden');
    }
});

exportConfirmBtn.addEventListener('click', () => {
    const format = document.getElementById('exportFormat').value;
    const timestamps = document.getElementById('exportTimestamps').checked ? "1" : "0";
    const speakers = document.getElementById('exportSpeakers').checked ? "1" : "0";

    // Use transcription filename if available
    const filename = "{{ transcription.audio_file.name|slice:'20:'|default:'transcript' }}";

    const url = `{% url 'transcription:export_transcript' transcription.id %}?format=${format}&timestamps=${timestamps}&speakers=${speakers}&filename=${filename}`;
    window.location.href = url;
});

// ======================
// Transcript Filtering Logic
// ======================
const segmentRows = Array.from(document.querySelectorAll(".segment-row"));
const VIRTUAL_LIMIT = 200;
let virtualMode = segmentRows.length > VIRTUAL_LIMIT;
let loadedCount = Math.min(VIRTUAL_LIMIT, segmentRows.length);

function applyVirtualization() {
    if (!virtualMode) return;
    segmentRows.forEach((row, idx) => {
        row.classList.toggle("hidden", idx >= loadedCount);
    });
}

function loadMoreSegments() {
    loadedCount = Math.min(loadedCount + 200, segmentRows.length);
    applyVirtualization();
}
const segmentIndex = segmentRows.map(row => ({
    row: row,
    text: row.dataset.text.toLowerCase(),
    type: row.dataset.type,
    speaker: row.dataset.speaker
}));
const segments = segmentRows.map(row => ({
    row,
    start: parseFloat(row.dataset.start || "0"),
    end: parseFloat(row.dataset.end || "0"),
}));

applyVirtualization();

window.addEventListener("scroll", () => {
    if (!virtualMode) return;
    const nearBottom = window.innerHeight + window.scrollY > document.body.offsetHeight - 800;
    if (nearBottom) {
        loadMoreSegments();
    }
});
let matchRows = [];
let matchIndex = -1;

function highlightMatches(query) {
    matchRows = [];
    matchIndex = -1;
    document.querySelectorAll(".segment-row").forEach(r => {
        r.classList.remove("ring-2", "ring-yellow-200");
    });
    if (!query) return;
    segmentIndex.forEach(item => {
        if (item.text.includes(query)) {
            item.row.classList.add("ring-2", "ring-yellow-200");
            matchRows.push(item.row);
        }
    });
}

function jumpToMatch(dir) {
    if (!matchRows.length) return;
    matchIndex = (matchIndex + dir + matchRows.length) % matchRows.length;
    const row = matchRows[matchIndex];
    row.scrollIntoView({ behavior: "smooth", block: "center" });
    row.classList.add("ring-2", "ring-yellow-400");
    setTimeout(() => row.classList.remove("ring-yellow-400"), 600);
}

function setSaveStatus(text) {
    if (!saveStatus) return;
    saveStatus.textContent = text;
}

function updateColumnVisibility() {
    const showOriginal = toggleOriginal?.checked ?? true;
    const showEnglish = toggleEnglish?.checked ?? true;
    requestAnimationFrame(() => {
        document.querySelectorAll(".col-original").forEach(el => {
            el.classList.toggle("hidden", !showOriginal);
        });
        document.querySelectorAll(".col-english").forEach(el => {
            el.classList.toggle("hidden", !showEnglish);
        });
    });
}

toggleOriginal?.addEventListener("change", updateColumnVisibility);
toggleEnglish?.addEventListener("change", updateColumnVisibility);
updateColumnVisibility();

// ======================
// Auto-save logic
// ======================
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return null;
}

const csrfToken = getCookie("csrftoken");
const saveTimers = new Map();

function scheduleSave(textarea) {
    const row = textarea.closest(".segment-row");
    if (!row) return;
    const index = row.dataset.index;
    const field = textarea.dataset.field;
    const value = textarea.value;

    if (saveTimers.has(textarea)) {
        clearTimeout(saveTimers.get(textarea));
    }

    saveTimers.set(
        textarea,
        setTimeout(async () => {
            try {
                await fetch("{% url 'transcription:save_segment' transcription.id %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken || "",
                    },
                    body: JSON.stringify({ index, field, value }),
                });
                textarea.classList.add("ring-2", "ring-green-200");
                setTimeout(() => textarea.classList.remove("ring-2", "ring-green-200"), 600);
                setSaveStatus(`Saved at ${new Date().toLocaleTimeString()}`);
            } catch (err) {
                textarea.classList.add("ring-2", "ring-red-200");
                setTimeout(() => textarea.classList.remove("ring-2", "ring-red-200"), 1000);
                setSaveStatus("Save failed");
            }
        }, 500)
    );
}

document.querySelectorAll(".auto-save").forEach(textarea => {
    textarea.addEventListener("input", () => scheduleSave(textarea));
});

// ======================
// Speaker rename (client-side only)
// ======================
document.querySelectorAll(".rename-speaker").forEach(btn => {
    btn.addEventListener("click", () => {
        const current = btn.dataset.speaker || "UNKNOWN";
        const next = prompt("Rename speaker:", current);
        if (!next || next.trim() === current) return;
        document.querySelectorAll(".segment-row").forEach(row => {
            if (row.dataset.speaker === current) {
                row.dataset.speaker = next.trim();
                const chip = row.querySelector("span");
                if (chip) chip.textContent = next.trim();
            }
        });
    });
});

// ======================
// LLM Translate Button
// ======================
translateBtn.addEventListener("click", async () => {
    translateStatus.textContent = "Translation is not enabled yet.";
    return;
    translateBtn.disabled = true;
    translateBtn.classList.add("opacity-70", "cursor-not-allowed");
    translateStatus.textContent = "Translating...";
    try {
        const res = await fetch("{% url 'transcription:translate_transcription' transcription.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken || "",
            },
        });
        if (!res.ok) {
            throw new Error("Translation failed");
        }
        translateStatus.textContent = "Done. Refreshing...";
        window.location.reload();
    } catch (err) {
        translateStatus.textContent = "Translation failed. Please try again.";
    } finally {
        translateBtn.disabled = false;
        translateBtn.classList.remove("opacity-70", "cursor-not-allowed");
    }
});

// ======================
// Playback helpers (optimized)
// ======================
let activeSegmentRow = null;
let activeIndex = -1;
let lastScrollIndex = -1;
let rafPending = false;

function findActiveIndex(current, startIndex) {
    if (!segments.length) return -1;
    let i = Math.max(0, Math.min(startIndex, segments.length - 1));

    if (current >= segments[i].start && current <= segments[i].end) {
        return i;
    }

    // Search forward
    for (let j = i + 1; j < segments.length; j++) {
        if (current < segments[j].start) return j - 1;
        if (current >= segments[j].start && current <= segments[j].end) return j;
    }

    // Search backward
    for (let j = i - 1; j >= 0; j--) {
        if (current >= segments[j].start && current <= segments[j].end) return j;
        if (current > segments[j].end) return j;
    }

    return -1;
}

function updateActiveSegment() {
    const current = audio.currentTime || 0;
    const nextIndex = findActiveIndex(current, activeIndex === -1 ? 0 : activeIndex);
    if (nextIndex !== activeIndex) {
        if (activeSegmentRow) activeSegmentRow.classList.remove("bg-blue-100");
        activeIndex = nextIndex;
        activeSegmentRow = nextIndex >= 0 ? segments[nextIndex].row : null;
        if (activeSegmentRow) {
            if (virtualMode && activeIndex >= loadedCount) {
                loadedCount = activeIndex + 1;
                applyVirtualization();
            }
            activeSegmentRow.classList.add("bg-blue-100");
            if (lastScrollIndex !== activeIndex) {
                lastScrollIndex = activeIndex;
                activeSegmentRow.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }
    }

    if (loopToggle?.checked && activeSegmentRow) {
        const start = segments[activeIndex].start;
        const end = segments[activeIndex].end;
        if (current >= end) {
            audio.currentTime = start;
            audio.play();
        }
    }
}

audio.addEventListener("timeupdate", () => {
    if (rafPending) return;
    rafPending = true;
    requestAnimationFrame(() => {
        rafPending = false;
        updateActiveSegment();
    });
});

jumpPrev.addEventListener("click", () => jumpToMatch(-1));
jumpNext.addEventListener("click", () => jumpToMatch(1));

function applyFilters() {
    const q = searchInput.value.toLowerCase();
    const type = typeFilter.value;
    const speaker = speakerFilter.value;

    requestAnimationFrame(() => {
        segmentIndex.forEach(item => {
            const matchText = item.text.includes(q);
            const matchType = type === "all" || item.type === type;
            const matchSpeaker = speaker === "all" || item.speaker === speaker;

            const display = (matchText && matchType && matchSpeaker) ? "" : "none";
            item.row.style.display = display;
        });

        highlightMatches(q);
    });
}

// Debounce for performance on long transcripts
let filterTimeout;
[searchInput, typeFilter, speakerFilter].forEach(el =>
    el.addEventListener("input", () => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(applyFilters, 150);
    })
);
</script>
{% endblock %}
